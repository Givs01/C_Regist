{% extends "base_admin.html" %}
{% block content %}

<div class="w-full max-w-md p-6">
    <div class="flex align-baseline mb-6">
            <input type="text" id="searchInput" placeholder="Search users..."
                class="w-full max-w-md px-4 py-2 border border-gray-300 rounded-l-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-white"
                onkeyup="filterUsers()">

            <button onclick="filterUsers()"
                    class="px-4 py-2 bg-secondary text-white border border-gray-300 border-l-0 rounded-none hover:bg-tertiary">
                <i class="fa fa-search"></i>
            </button>

            <button type="button" onclick="downloadCSV()"
                    class="px-4 py-2 bg-secondary text-white border border-gray-300 border-l-0 rounded-r-lg hover:bg-tertiary">
                <i class="fa fa-file-csv"></i>
            </button>
        </div>

    
    <!-- GRID -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4" id="userGrid">
        {% for u in users %}
        <div class="user-card bg-white/10 border border-white/10 rounded-xl shadow-lg p-4 flex justify-between items-start hover:shadow-md transition-all">
            
            <!-- USER INFO -->
            <div class="flex flex-col space-y-1">
                <span class="text-white font-semibold name-desk"> {{ u.name | title }} 
                    <span class="font-normal text-xs text-white"> | {{ u.assignDesk }}</span>
                    <span class="font-bold  bg-white text-gray-800 rounded-full text-xs px-2 mx-2">{{ forloop.counter }}</span>
                </span>
                <span class="text-xs text-white user-id">ID: <span class="font-mono">{{ u.userId }}</span></span>
                <span class="text-xs text-white">Created: {{ u.created_at|date:"d M Y, h:i A" }}</span>
                <span id="pw-{{ u.id }}" data-password="{{ u.password }}" class="hidden"></span>
            </div>
            <!-- ACTION ICONS -->   
            <div class="flex flex-col gap-2">
                <button onclick="openEditModal('{{ u.id }}', '{{ u.assignDesk }}')" 
                        class="text-tertiary hover:text-blue-800 text-lg shadow-2xl shadow-white"> <i class="fa fa-edit"></i></button>
                <form method="POST" onsubmit="return confirm('Delete this user?');">
                    {% csrf_token %}
                    <input type="hidden" name="user_id" value="{{ u.id }}">
                    <button name="delete_user" class="text-red-600 hover:text-red-800 text-lg shadow-2xl shadow-white"> <i class="fa fa-trash"></i></button>
                </form>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- NO RESULTS MESSAGE -->
    <div id="noResults" class="text-center text-white mt-4 hidden">
        üîç No users found
    </div>
</div>

<!-- EDIT MODAL -->
<div id="editModal" class="fixed inset-0 bg-opacity-50 backdrop-blur-sm hidden flex items-center justify-center z-50">
    <div class="bg-white/50 border border-white/50 rounded-xl p-5 shadow-lg w-80">
        <h2 class="text-lg font-bold mb-4">Edit User</h2>

        <form method="POST" class="space-y-4">
            {% csrf_token %}
            <input type="hidden" id="edit_user_id" name="user_id">

            <div>
                <label class="text-sm font-medium text-gray-700">Assign Desk</label>
                <select id="editDeskInput" name="assignDesk" required
                        class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none text-white">
                    <option value="" disabled selected>Select Desk</option>
                    <option>Desk-1</option>
                    <option>Desk-2</option>
                    <option>Desk-3</option>
                    <option>Desk-4</option>
                    <option>Desk-5</option>
                    <option>Desk-6</option>
                    <option>Desk-7</option>
                    <option>Desk-8</option>
                </select>
            </div>

            <div>
                <label class="text-sm font-medium text-gray-700">New Password</label>
                <input type="text" name="password" placeholder="Enter new password"
                       class="w-full px-3 py-2 border rounded-lg text-white" />
            </div>

            <div class="flex justify-between mt-4 text-xs gap-6">
                <button type="button"
                        onclick="closeModal()"
                        class="w-[150px] px-4 py-2 bg-white/80 rounded-lg shadow-2xl shadow-white">
                    Cancel
                </button>

                <button name="update_desk"
                        class="w-[150px] px-4 py-2 bg-red-700 text-white rounded-lg hover:bg-red-800">
                    Save
                </button>
            </div>
        </form>
    </div>
</div>
<script>


    function openEditModal(id, desk) {
        document.getElementById("editModal").classList.remove("hidden");
        document.getElementById("edit_user_id").value = id;
        document.getElementById("editDeskInput").value = desk;
    }

    function closeModal() {
        document.getElementById("editModal").classList.add("hidden");
    }

    function togglePassword(id, password) {
        const pwEl = document.getElementById('pw-' + id);
        if (pwEl.textContent === '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢') {
            pwEl.textContent = password;
        } else {
            pwEl.textContent = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
        }
    }

    function filterUsers() {
        const input = document.getElementById('searchInput').value.toLowerCase();
        const cards = document.querySelectorAll('#userGrid .user-card');
        let anyVisible = false;

        cards.forEach(card => {
            const nameEl = card.querySelector('.name-desk');
            const deskEl = nameEl.querySelector('span'); // desk part
            const idEl = card.querySelector('.user-id span');

            const nameText = nameEl.firstChild.textContent.toLowerCase(); // only name
            const idText = idEl.textContent.toLowerCase();

            // Reset highlights
            nameEl.firstChild.textContent = nameEl.firstChild.textContent;
            idEl.textContent = idEl.textContent;

            if (nameText.includes(input) || idText.includes(input)) {
                card.style.display = 'flex';
                anyVisible = true;

                // Highlight only the name
                const regex = new RegExp(`(${input})`, 'gi');
                nameEl.firstChild.innerHTML = nameEl.firstChild.textContent.replace(regex, `<span class="bg-yellow-200">$1</span>`);

                // Highlight ID
                idEl.innerHTML = idEl.textContent.replace(regex, `<span class="bg-yellow-200">$1</span>`);
            } else {
                card.style.display = 'none';
            }
        });

        document.getElementById('noResults').style.display = anyVisible ? 'none' : 'block';
    }

    function downloadCSV() {
        const cards = document.querySelectorAll('#userGrid .user-card');
        let csvContent = "Name,Desk,User ID,Created At,Password\n";

        cards.forEach(card => {
            if (card.style.display !== 'none') {

                const name = card.querySelector('.name-desk').firstChild.textContent.trim();
                const desk = card.querySelector('.name-desk span').textContent.replace('|', '').trim();
                const userId = card.querySelector('.user-id span').textContent.trim();

                // Select the "Created:" row correctly
                const created = card.querySelectorAll('.text-xs.text-white')[1].textContent
                    .replace("Created:", "")
                    .trim();

                const password = card.querySelector('[id^="pw-"]').dataset.password;

                csvContent += `"${name}","${desk}","${userId}","${created}","${password}"\n`;
            }
        });

        const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "users.csv";
        link.click();
    }




</script>



{% endblock %}
