{% extends "base.html" %}
{% block content %}

<div class="flex flex-col w-full p-6 items-center justify-center">

    <div class="text-center mb-10">
        <h1 class="text-2xl font-bold text-white drop-shadow-md">
            QR Registration
        </h1>
        <p class="text-gray-400 text-xs mt-2">Register a participant automatically</p>
    </div>

    <!-- Scanner Card -->
    <div id="scanner-card"
         class="bg-black/40 border border-white/10 rounded-2xl p-4 shadow-lg max-w-md w-full">
        <div class="relative w-full rounded-xl overflow-hidden mx-auto"
             style="aspect-ratio: 1; background:#000">
            <div id="qr-container"></div>

            <canvas id="overlay-canvas"
                    class="absolute inset-0 pointer-events-none"></canvas>
        </div>

        <p id="msg" class="text-gray-400 text-xs mt-2 text-center">
            Allow camera access to begin scanning
        </p>

        <div class="flex items-center justify-center gap-3 mt-6">
            <button id="switch-camera"
                    class="text-xs px-3 py-2 rounded-full text-white bg-secondary">
                Switch Camera
            </button>
            <button id="toggle-mode"
                    class="text-xs px-3 py-2 rounded-full text-white bg-secondary">
                Enter QR Manually
            </button>
        </div>
    </div>

    <!-- Manual Entry -->
    <div id="manual-card"
         class="hidden bg-black/20 border border-white/10 rounded-2xl p-6 shadow-lg
                max-w-md w-full flex flex-col items-center justify-center">

        <form id="manual-form" method="POST" action="{% url 'qr_register' %}"
              class="w-full flex flex-col items-center justify-center gap-4">
            {% csrf_token %}

            <input type="text" name="qr_code"
                   class="w-2/3 text-sm px-3 py-2 rounded-lg bg-black/30 border border-gray-600 text-white"
                   placeholder="Enter QR Code">

            <button class="w-1/2 bg-indigo-500 hover:bg-indigo-600 py-2 rounded-lg text-white font-medium shadow">
                Submit
            </button>
        </form>
    </div>

    <!-- Auto Submit -->
    <form id="auto-form" method="POST" action="{% url 'qr_register' %}">
        {% csrf_token %}
        <input type="hidden" name="qr_code" id="qr_value">
    </form>

</div>

<!-- Confirmation Modal -->
<div id="confirm-modal"
     class="fixed inset-0 bg-black/60 hidden flex items-center justify-center z-50">
    <div class="bg-gray-900 border border-white/10 rounded-xl p-6 max-w-xs w-full text-center animate-fadeIn">
        <p class="text-white text-sm mb-2">Scanned Code:</p>
        <p id="confirm-text" class="text-indigo-400 font-bold text-lg break-words"></p>

        <div class="flex justify-center gap-3 mt-6">
            <button id="confirm-accept"
                    class="px-4 py-2 rounded-lg bg-green-600 hover:bg-green-700 text-white text-xs">
                Accept
            </button>
            <button id="confirm-reject"
                    class="px-4 py-2 rounded-lg bg-red-600 hover:bg-red-700 text-white text-xs">
                Reject
            </button>
        </div>
    </div>
</div>

<script src="https://unpkg.com/html5-qrcode"></script>

<script>
const toggleBtn = document.getElementById("toggle-mode");
const scannerCard = document.getElementById("scanner-card");
const manualCard = document.getElementById("manual-card");
const msg = document.getElementById("msg");
const overlayCanvas = document.getElementById("overlay-canvas");

let scanner = null;
let cameras = [];
let currentCam = 0;
let track = null;

function drawBox() {
    const ctx = overlayCanvas.getContext("2d");

    const w = overlayCanvas.width;
    const h = overlayCanvas.height;

    ctx.clearRect(0, 0, w, h);
    ctx.strokeStyle = "#00eaff";
    ctx.lineWidth = 3;

    // 70% of the shortest side
    const size = Math.min(w, h) * 0.65;

    const x = (w - size) / 2;
    const y = (h - size) / 2;

    ctx.strokeRect(x, y, size, size);
}


async function start() {
    try {
        await navigator.mediaDevices.getUserMedia({ video: true });
        cameras = await Html5Qrcode.getCameras();
        if (!cameras.length) return alert("No camera found");

        const back = cameras.findIndex(c => c.label.toLowerCase().includes("back"));
        if (back !== -1) currentCam = back;

        scanner = new Html5Qrcode("qr-container");

        await scanner.start(
            cameras[currentCam].id,
            { fps: 10 },
            qrDetected,
            () => {}
        );

        msg.innerText = "Scanning...";
        const video = document.querySelector("#qr-container video");
        track = video.srcObject.getVideoTracks()[0];

        const updateCanvasSize = () => {
            const rect = video.getBoundingClientRect();
            overlayCanvas.width = rect.width;
            overlayCanvas.height = rect.height;
            drawBox();
        };

        // Wait for video to fully render
        setTimeout(updateCanvasSize, 300);
        window.addEventListener("resize", updateCanvasSize);

    } catch (e) {
        msg.innerText = "Camera access denied";
    }
}

function stop() {
    if (!scanner) return;
    return scanner.stop().then(() => scanner.clear());
}

function qrDetected(text) {
    stop();
    showConfirmation(text);
}

function showConfirmation(text) {
    document.getElementById("qr_value").value = text;
    document.getElementById("confirm-text").innerText = text;
    document.getElementById("confirm-modal").classList.remove("hidden");
}

document.getElementById("confirm-accept").onclick = () => {
    document.getElementById("confirm-modal").classList.add("hidden");
    document.getElementById("auto-form").submit();
};

document.getElementById("confirm-reject").onclick = () => {
    document.getElementById("confirm-modal").classList.add("hidden");
    msg.innerText = "Scanning...";
    start();
};

document.getElementById("switch-camera").onclick = () => {
    if (!cameras.length) return;
    currentCam = (currentCam + 1) % cameras.length;
    stop().then(() => setTimeout(start, 300));
};

toggleBtn.onclick = () => {
    if (manualCard.classList.contains("hidden")) {
        manualCard.classList.remove("hidden");
        scannerCard.classList.add("hidden");
        toggleBtn.textContent = "Back to Scanner";
        stop();
    } else {
        scannerCard.classList.remove("hidden");
        manualCard.classList.add("hidden");
        toggleBtn.textContent = "Enter QR Manually";
        start();
    }
};

window.onload = () => setTimeout(start, 500);
</script>

<style>
    #qr-container video {
    object-fit: cover !important;
    width: 100% !important;
    height: 100% !important;
}

    @keyframes fadeIn {
        from { opacity: 0; transform: scale(0.95); }
        to { opacity: 1; transform: scale(1); }
    }
    .animate-fadeIn {
        animation: fadeIn .2s ease-out;
    }
</style>
{% endblock %}
