{% extends "base.html" %}
{% block content %}

<div class="w-full px-4 py-6 flex flex-col items-center text-center">

    <!-- Page Title -->
    <h1 class="text-xl font-bold text-indigo-300 mb-4">QR Registration</h1>

    <!-- Toggle Manual Button -->
    <button id="toggle-manual"
        class="text-xs px-4 py-2 bg-indigo-600/30 hover:bg-indigo-600/40 text-white
               rounded-full transition mb-6">
        Enter QR Manually
    </button>

    <!-- SCANNER SECTION -->
    <div id="scanner-section"
        class="bg-black/30 border border-white/10 rounded-2xl p-6 shadow-lg
               max-w-md w-full">

        <p class="text-gray-300 text-sm mb-2">Scan QR Code</p>

        <div id="qr-reader" class="
            bg-black w-full rounded-xl overflow-hidden
            h-[360px] max-w-md mx-auto
        "></div>

        <p class="text-gray-400 text-xs mt-3">Allow camera access to continue</p>
    </div>

    <!-- MANUAL ENTRY SECTION -->
    <div id="manual-section"
        class="hidden bg-black/20 border border-white/10 rounded-2xl p-6 shadow-lg
               max-w-md w-full">

        <p class="text-gray-400 text-xs mb-3">Enter QR Code Manually</p>

        <form id="manual-submit-form" method="POST" action="{% url 'qr_register' %}">
            {% csrf_token %}
            <input type="text" name="qr_code"
                class="w-full px-3 py-2 rounded-lg bg-black/40 border border-gray-600
                       text-white text-sm focus:ring focus:ring-indigo-500 mb-4"
                placeholder="QR Code">

            <button type="submit"
                class="w-full bg-indigo-500 hover:bg-indigo-600 text-white font-medium
                       py-2 rounded-lg">
                Register
            </button>
        </form>
    </div>

    <!-- Hidden Auto Submission -->
    <form id="auto-form" method="POST" action="{% url 'qr_register' %}">
        {% csrf_token %}
        <input type="hidden" name="qr_code" id="qr_value">
    </form>

</div>


<!-- QR SCANNER SCRIPT -->
<script src="https://unpkg.com/html5-qrcode@2.3.10/minified/html5-qrcode.min.js"></script>
<script>
const qrBox = document.getElementById("qr-reader");
const scannerSection = document.getElementById("scanner-section");
const manualSection = document.getElementById("manual-section");
const toggleBtn = document.getElementById("toggle-manual");
const qrInput = document.getElementById("qr_value");
let scanner = null;

// Ask for permission + camera start
async function initScanner() {
    try {
        await navigator.mediaDevices.getUserMedia({ video: true });
        const cams = await Html5Qrcode.getCameras();
        if (!cams.length) return alert("No Camera Found!");

        const camera = cams.find(c => c.label.toLowerCase().includes("back"))?.id || cams[0].id;

        scanner = new Html5Qrcode("qr-reader");

        await scanner.start(
            camera,
            { fps: 12, qrbox: { width: 250, height: 250 } },
            onScanSuccess
        );

    } catch (err) {
        console.error(err);
        alert("Camera access required. Please allow permission!");
        qrBox.innerHTML = `<p class='text-red-300 text-sm p-4'>Camera permission denied</p>`;
    }
}

// Stop camera
function stopScanner() {
    if (scanner) {
        scanner.stop().then(() => scanner.clear());
    }
}

// QR Success Handler
function onScanSuccess(text) {
    console.log("QR:", text);
    stopScanner();
    qrInput.value = text;
    document.getElementById("auto-form").submit();
}

// Toggle Manual / Scanner Mode
toggleBtn.addEventListener("click", () => {
    if (manualSection.classList.contains("hidden")) {
        // Switch to manual
        stopScanner();
        scannerSection.classList.add("hidden");
        manualSection.classList.remove("hidden");
        toggleBtn.textContent = "Back to Scanner";
    } else {
        // Switch to scanner
        manualSection.classList.add("hidden");
        scannerSection.classList.remove("hidden");
        toggleBtn.textContent = "Enter QR Manually";
        initScanner();
    }
});

// Auto start camera
window.onload = () => {
    setTimeout(initScanner, 300);
};
</script>

{% endblock %}
