{% extends "base.html" %}
{% block content %}

<div class="flex flex-col w-full p-6 items-center justify-center">

    <div class="text-center mb-10">
        <h1 class="text-2xl font-bold text-white drop-shadow-md">
            QR Registration
        </h1>
        <p class="text-gray-400 text-xs mt-2">Register a participant automatically</p>
    </div>

    <!-- Scanner Card -->
    <div id="scanner-card"
        class="bg-black/40 border border-white/10 rounded-2xl p-4 shadow-lg max-w-md w-full">
        <div class="relative w-full rounded-xl overflow-hidden mx-auto"
             style="aspect-ratio: 1; background:#000">
            <div id="qr-container"></div>

            <!-- Canvas Overlay (Scanner Window) -->
            <canvas id="overlay-canvas"
                class="absolute inset-0 pointer-events-none"></canvas>
        </div>



        <p id="msg" class="text-gray-400 text-xs mt-2 text-center">
            Allow camera access to begin scanning
        </p>

        <div class="flex items-center justify-center gap-3 mt-6">
            <button id="switch-camera"
                class="text-xs px-3 py-2 rounded-full text-white bg-secondary">
                Switch Camera
            </button>
            <!-- Toggle Button -->
            <button id="toggle-mode"
                class="text-xs px-3 py-2 rounded-full text-white bg-secondary">
                Enter QR Manually
            </button>
        </div>
    </div>

    <!-- Manual Entry -->
    <div id="manual-card"
        class="hidden bg-black/20 border border-white/10 rounded-2xl p-6 shadow-lg
        max-w-md w-full flex flex-col items-center justify-center">

        <form id="manual-form" method="POST" action="{% url 'qr_register' %}"
            class="w-full flex flex-col items-center justify-center gap-4">
            {% csrf_token %}

            <input type="text" name="qr_code"
                class="w-2/3 text-sm px-3 py-2 rounded-lg bg-black/30 border border-gray-600 text-white"
                placeholder="Enter QR Code">

            <button class="w-1/2 bg-indigo-500 hover:bg-indigo-600 py-2 rounded-lg text-white font-medium shadow">
                Submit
            </button>
        </form>

    </div>


    <!-- Auto Submit -->
    <form id="auto-form" method="POST" action="{% url 'qr_register' %}">
        {% csrf_token %}
        <input type="hidden" name="qr_code" id="qr_value">
    </form>

</div>

<!-- HTML5 QR Code Library -->
<script src="https://unpkg.com/html5-qrcode"></script>

<script>
const toggleBtn = document.getElementById("toggle-mode");
const scannerCard = document.getElementById("scanner-card");
const manualCard = document.getElementById("manual-card");
const qrContainer = document.getElementById("qr-container");
const overlayCanvas = document.getElementById("overlay-canvas");
const msg = document.getElementById("msg");

let scanner = null;
let cameras = [];
let currentCam = 0;
let track = null;
let torch = false;

function drawBox() {
    const ctx = overlayCanvas.getContext("2d");
    const w = overlayCanvas.width;
    const h = overlayCanvas.height;
    ctx.clearRect(0, 0, w, h);

    ctx.strokeStyle = "#00eaff";
    ctx.lineWidth = 3;
    const size = Math.min(w, h) * 0.7;
    const x = (w - size) / 2;
    const y = (h - size) / 2;
    ctx.strokeRect(x, y, size, size);
}

async function start() {
    try {
        await navigator.mediaDevices.getUserMedia({ video: true });
        cameras = await Html5Qrcode.getCameras();
        if (!cameras.length) return alert("No camera found!");

        const back = cameras.findIndex(c => c.label.toLowerCase().includes("back"));
        if (back !== -1) currentCam = back;

        scanner = new Html5Qrcode("qr-container");

        scanner.start(
            cameras[currentCam].id,
            { fps: 10 },
            qrSuccess,
            () => {}
        ).then(() => {
            msg.innerText = "Scanning...";
            const video = document.querySelector("#qr-container video");
            track = video.srcObject.getVideoTracks()[0];

            overlayCanvas.width = video.clientWidth;
            overlayCanvas.height = video.clientHeight;
            drawBox();
        });
    } catch (e) {
        console.log(e);
        msg.innerText = "Camera access denied";
    }
}

function stop() {
    if (!scanner) return;
    scanner.stop().then(() => scanner.clear());
}

function qrSuccess(text) {
    stop();
    document.getElementById("qr_value").value = text;
    document.getElementById("auto-form").submit();
}

document.getElementById("switch-camera").onclick = () => {
    if (!cameras.length) return;
    currentCam = (currentCam + 1) % cameras.length;
    stop();
    setTimeout(start, 300);
};


toggleBtn.onclick = () => {
    if (manualCard.classList.contains("hidden")) {
        manualCard.classList.remove("hidden");
        scannerCard.classList.add("hidden");
        toggleBtn.textContent = "Back to Scanner";
        stop();
    } else {
        scannerCard.classList.remove("hidden");
        manualCard.classList.add("hidden");
        toggleBtn.textContent = "Enter QR Manually";
        start();
    }
};

window.onload = () => setTimeout(start, 500);
</script>

{% endblock %}
